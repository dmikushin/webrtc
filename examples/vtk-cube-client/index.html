<!DOCTYPE html>
<html>
<head>
  <title>VTK Cube WebRTC Client</title>
  <style>
    #remoteVideo { width: 640px; height: 480px; background: #222; }
  </style>
</head>
<body>
  <h2>VTK Cube WebRTC Video</h2>
  <video id="remoteVideo" autoplay playsinline controls></video>
  <script>
    // --- Config ---
    const SIGNALING_URL = "ws://localhost:8080"; // Change to your signaling server address

    // --- WebRTC setup ---
    const pc = new RTCPeerConnection();
    let dataChannel = null;
    const video = document.getElementById('remoteVideo');
    pc.ontrack = (event) => {
      video.srcObject = event.streams[0];
    };

    // --- Data channel for input events ---
    pc.ondatachannel = (event) => {
      dataChannel = event.channel;
      setupInputEvents();
    };

    function setupInputEvents() {
      if (!dataChannel) return;
      // Mouse events
      video.addEventListener('mousedown', e => sendInput({type: 'mousedown', x: e.offsetX, y: e.offsetY, button: e.button}));
      video.addEventListener('mouseup', e => sendInput({type: 'mouseup', x: e.offsetX, y: e.offsetY, button: e.button}));
      video.addEventListener('mousemove', e => sendInput({type: 'mousemove', x: e.offsetX, y: e.offsetY}));
      // Keyboard events
      window.addEventListener('keydown', e => sendInput({type: 'keydown', key: e.key, code: e.code}));
      window.addEventListener('keyup', e => sendInput({type: 'keyup', key: e.key, code: e.code}));
    }

    function sendInput(obj) {
      if (dataChannel && dataChannel.readyState === 'open') {
        dataChannel.send(JSON.stringify(obj));
      }
    }

    // --- Signaling via WebSocket ---
    const ws = new WebSocket(SIGNALING_URL);

    ws.onopen = async () => {
      // Create data channel for input if we are the offerer
      dataChannel = pc.createDataChannel("input");
      dataChannel.onopen = setupInputEvents;

      // Create and send offer
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      ws.send(JSON.stringify({type: "offer", sdp: offer.sdp}));
    };

    ws.onmessage = async (event) => {
      const msg = JSON.parse(event.data);
      if (msg.type === "answer") {
        await pc.setRemoteDescription(new RTCSessionDescription({type: "answer", sdp: msg.sdp}));
      } else if (msg.type === "candidate") {
        await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
      }
    };

    pc.onicecandidate = (event) => {
      if (event.candidate) {
        ws.send(JSON.stringify({type: "candidate", candidate: event.candidate}));
      }
    };
  </script>
</body>
</html>
